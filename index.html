<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Doanh thu BOT Bắc Giang - Lạng Sơn</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-red: #e31e24; --bg-color: #121216; --gold: #ffd700; --card-bg: rgba(255,255,255,0.08); }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg-color); color: white; min-height: 100vh; overflow-x: hidden; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://deoca.vn/file/banner/1695181765-baner%20web-01%20(1).jpg'); background-size: cover; background-position: center; opacity: 0.15; z-index: -1; }
        .container { width: 95%; max-width: 1600px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        header { text-align: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255,30,36,0.3); padding-bottom: 15px; }
        h1 { font-size: 26px; margin: 0; font-weight: 900; letter-spacing: 1px; }
        h2 { font-size: 17px; color: #ccc; margin: 5px 0; font-weight: 700; }

        .top-dashboard { display: grid; grid-template-columns: 280px 1fr 280px; gap: 20px; align-items: stretch; margin-bottom: 30px; }
        .logo-column { display: flex; flex-direction: column; gap: 15px; }
        .logo-card { background: white; padding: 10px; border-radius: 12px; height: 120px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        .logo-card img.deoca { height: 75%; width: auto; }
        .logo-card img.bot { width: 100%; height: 100%; object-fit: contain; transform: scale(1.4); }

        .rev-main-container { display: flex; flex-direction: column; gap: 10px; justify-content: center; }
        .rev-row { background: var(--card-bg); border-left: 6px solid var(--primary-red); border-radius: 8px; padding: 15px 30px; display: grid; grid-template-columns: 180px 1fr 1fr; align-items: center; backdrop-filter: blur(5px); }
        .rev-row.total-row { border-left-color: var(--gold); background: rgba(255, 215, 0, 0.12); }
        .rev-name { font-size: 15px; font-weight: 900; color: #ddd; text-transform: uppercase; }
        .rev-name small { display: block; font-size: 11px; color: var(--primary-red); margin-top: 3px; }
        .rev-group { display: flex; flex-direction: column; text-align: right; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px; }
        .rev-group:last-child { border-right: none; padding-right: 0; }
        .rev-tag { font-size: 11px; color: #888; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .rev-val { font-size: 22px; font-weight: 900; }
        .total-row .rev-val { color: var(--gold); font-size: 28px; }

        .chart-column { background: var(--card-bg); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .chart-wrap { width: 160px; height: 160px; }
        .chart-text { font-size: 11px; text-align: center; margin-top: 15px; color: #aaa; font-weight: 700; }

        .bottom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .info-box { background: #fff; color: #111; padding: 20px; border-radius: 12px; display: flex; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .info-icon { background: var(--primary-red); color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-right: 20px; flex-shrink: 0; font-size: 18px; font-weight: 900; }
        .info-content h4 { margin: 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .info-content p { margin: 5px 0 0 0; font-size: 19px; font-weight: 900; color: #000; }
    </style>
</head>
<body>

    <div class="container">
        <header> </br>
            <h1>CÔNG TY CỔ PHẦN BOT BẮC GIANG - LẠNG SƠN</h1>
            <h2>XÍ NGHIỆP QUẢN LÝ VẬN HÀNH ĐƯỜNG CAO TỐC BẮC GIANG - LẠNG SƠN</h2>
            <h2>BÁO CÁO TÌNH HÌNH QUẢN LÝ VẬN HÀNH KHAI THÁC</h2>
        </header>
</br>
        <div class="top-dashboard">
            <div class="logo-column">
                <div class="logo-card"><img src="https://deoca.vn/giaodien/default/images/dcg-logo-no-R-2021-vi.png" class="deoca"></div>
                <div class="logo-card"><img src="https://varsi.vn/file/thanhvien/1539231563-bgls.jpg" class="bot"></div>
            </div>

            <div class="rev-main-container">
                <div class="rev-row">
                    <div class="rev-name">Doanh thu QL1<small id="t_ql1">Đang tải...</small></div>
                    <div class="rev-group"><span class="rev-tag">Trong tháng</span><span class="rev-val" id="ql1_t">...</span></div>
                    <div class="rev-group"><span class="rev-tag">Lũy kế</span><span class="rev-val" id="ql1_l">...</span></div>
                </div>
                <div class="rev-row">
                    <div class="rev-name">Doanh thu Cao tốc<small id="t_ct">Đang tải...</small></div>
                    <div class="rev-group"><span class="rev-tag">Trong tháng</span><span class="rev-val" id="ct_t">...</span></div>
                    <div class="rev-group"><span class="rev-tag">Lũy kế</span><span class="rev-val" id="ct_l">...</span></div>
                </div>
                <div class="rev-row total-row">
                    <div class="rev-name">TỔNG CỘNG GỘP<small>Hệ thống tự động</small></div>
                    <div class="rev-group"><span class="rev-tag">Tổng trong tháng</span><span class="rev-val" id="all_t">...</span></div>
                    <div class="rev-group"><span class="rev-tag">Tổng lũy kế</span><span class="rev-val" id="all_l">...</span></div>
                </div>
            </div>

            <div class="chart-column">
                <div class="chart-wrap"><canvas id="timeChart"></canvas></div>
                <div class="chart-text">TIẾN ĐỘ THỜI GIAN<br>THU PHÍ DỰ KIẾN</div>
            </div>
        </div>
</br>
        <div class="bottom-grid" id="bottom-grid">
            </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQSiSNJCaZGlaZStoTr8LlX-mnN8LkJ3LOqnel8I27bsCUHzX8wGpoPX6teR413rOUSMmgOP-5P3EH_/pub?output=csv';
        const START_DATE = new Date(2018, 5, 1);
        const END_DATE = new Date(2046, 11, 31);

        function formatMoney(v) {
            let num = String(v).replace(/[^0-9]/g, '');
            return num ? Number(num).toLocaleString('vi-VN') + " ĐỒNG" : "0 ĐỒNG";
        }

        async function fetchData() {
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(CSV_URL + '&cache_bust=' + Date.now())}`;
            try {
                const res = await fetch(proxy);
                const json = await res.json();
                let raw = json.contents;
                if (raw.includes('base64,')) raw = decodeURIComponent(escape(window.atob(raw.split('base64,')[1])));
                
                const rows = raw.split(/\r?\n/);
                const data = {};

                rows.forEach(row => {
                    // Xử lý CSV: tách theo dấu phẩy nhưng giữ nội dung trong ngoặc kép
                    const parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (parts.length >= 2) {
                        const key = parts[0].trim().replace(/^"|"$/g, '');
                        const val = parts[1].trim().replace(/^"|"$/g, '');
                        data[key] = val;
                    }
                });

                // Chuyển đổi số để tính toán
                const parseNum = (val) => parseInt(String(val).replace(/[^0-9]/g, '')) || 0;

                const q1t = parseNum(data['ql1_thang']);
                const q1l = parseNum(data['ql1_luyke']);
                const ctt = parseNum(data['ct_thang']);
                const ctl = parseNum(data['ct_luyke']);

                // Hiển thị Doanh thu
                document.getElementById('ql1_t').innerText = formatMoney(q1t);
                document.getElementById('ql1_l').innerText = formatMoney(q1l);
                document.getElementById('ct_t').innerText = formatMoney(ctt);
                document.getElementById('ct_l').innerText = formatMoney(ctl);
                document.getElementById('all_t').innerText = formatMoney(q1t + ctt);
                document.getElementById('all_l').innerText = formatMoney(q1l + ctl);

                // Cập nhật tháng hiện tại (lùi 1 tháng so với thực tế để báo cáo)
                const d = new Date(); d.setMonth(d.getMonth() - 1);
                const mLabel = `Tháng ${d.getMonth() + 1}/${d.getFullYear()}`;
                document.getElementById('t_ql1').innerText = mLabel;
                document.getElementById('t_ct').innerText = mLabel;

                // Tính toán thời gian
                const now = new Date();
                const totalM = (END_DATE.getFullYear() - START_DATE.getFullYear()) * 12 + (END_DATE.getMonth() - START_DATE.getMonth());
                const remM = Math.max(0, (END_DATE.getFullYear() - now.getFullYear()) * 12 + (END_DATE.getMonth() - now.getMonth()));

                const gridHTML = [
                    {h: "Tổng mức đầu tư", p: data['tong_dau_tu'] || '12.188 TỶ ĐỒNG'},
                    {h: "Thời gian thu", p: data['thoi_gian_thu'] || '28 NĂM 07 THÁNG'},
                    {h: "Tổng thời gian thu", p: `${Math.floor(totalM/12)} NĂM ${(totalM%12).toString().padStart(2,'0')} THÁNG`},
                    {h: "Bắt đầu thu", p: data['ngay_bat_dau'] || '01/06/2018'},
                    {h: "Thời gian còn lại", p: `${remM} THÁNG (DỰ KIẾN)`},
                    {h: "SĐT Phản ánh", p: data['hotline'] || '1900.57.57.79'}
                ].map(item => `
                    <div class="info-box">
                        <div class="info-icon">✓</div>
                        <div class="info-content"><h4>${item.h}</h4><p>${item.p}</p></div>
                    </div>
                `).join('');
                document.getElementById('bottom-grid').innerHTML = gridHTML;

                updateChart(totalM - remM, remM);
            } catch (e) {
                console.error("Lỗi:", e);
                setTimeout(fetchData, 5000);
            }
        }

        let myChart;
        function updateChart(da, con) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [da, con], backgroundColor: ['#e31e24', 'rgba(255,255,255,0.1)'], borderWidth: 0 }] },
                options: { cutout: '80%', plugins: { legend: { display: false } } }
            });
        }

        fetchData();
        setInterval(fetchData, 300000);
        // Tự động reload 1h sáng
        const rt = new Date(); rt.setHours(1,0,0,0);
        if (new Date() > rt) rt.setDate(rt.getDate()+1);
        setTimeout(() => location.reload(), rt - new Date());
    </script>
</body>
</html>
